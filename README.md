# Socket网络编程进阶与实战 系统掌握Socket技术
## 第1章 课程导学
- Socket难在哪里？
  - HTTP很简单，但自己造一个HTTP框架很难
  - 平时都在用推送、IM聊天，但自己写一个推送框架很难
  - 物联网正在蓬勃发展，但是进行数据传输很难
  - 归根到底：只是会用而不知内部原理-高大上；难直接使用
- 为什么Socket难直接用？
  - 数据粘包
  - 数据丢包
  - 心跳维持
  - 性能问题
  - 系统学习
  - Demo肤浅
- 学习目标与收获
  - 拆开盒子，自己放东西
  - 提升技术、提升B格；愉快写代码
  - 可以自主实现一套推送框架
  - 让IM传输原理不再成为你技术上的盲点
  - 让你有能力胜任物联网相关开发职位，甚至是协议定制者
  - 让你对其他相关库的底层原理理解更透彻
- 底层协议
  - 报文
  - 协议
  - Mac地址
  - IP
  - 端口
  - 服务器
- NIO大家族
  - Selector
  - Channel
    - FileChannel
    - SocketChannel
    - ReadChannel
  - Buffer
    - ByteBuffer
    - CharBuffer
    - IntBuffer
- 群聊天
  - 多客户端链接
  - UDP扫描功能
  - 聊天消息转发
  - 向NIO的转型
  - 心跳包的实现
- 文件快传
  - 基于流的传输
  - 文件发送中断
  - 消息分片技术
  - 消息混发技术
- 即时语音
  - 直播推流
  - 语音采集
  - 语音压缩
  - 接收与播放
  - 实时消息模型
## 第2章 Socket网络编程快速入门
- 什么是网络编程
  - 什么是网络、计算机网络的构成是什么？
    - 在计算机领域中，网络是信息传输、接收、共享的虚拟平台
    - 通过它把各个点、面、体的信息联系到一起，从而实现这些资源的共享
    - 网络是人类发展史来最重要的发明，提高了科技和人类社会的发展
  - 什么是网络编程？
    - 网络编程从大的方面说就是对信息的发送到接收
    - 通过操作相应API调度计算机硬件资源，并利用传输管道（网线）进行数据交换的过程
    - 更为具体的涉及：网络模型、套接字、数据包
  - 7层网络模型-编程
    - 基础层：物理层（Physical）、数据链路层（Datalink）、网络层（Network）
    - 传输层（Transport）：TCP-UDP协议层、Socket
    - 高级层：会话层（Session）、表示层（Presentation）、应用层（Application）
- Socket与TCP、UDP
  - What is Socket?
    - 简单来说是IP地址与端口的结合协议（RFC 793）
    - 一种地址与端口的结合描述协议
    - TCP/IP协议的相关API的总称；是网络API的集合实现
    - 涵盖了：Stream Socket/Datagram Socket
  - Socket的作用与组成
    - 在网络传输中用于唯一标识两个端点之间的链接
    - 端点：包括（IP+Port）
    - 4个要素：客户端地址、客户端端口、服务器地址、服务器端口
  - Socket之TCP
    - TCP是面向连接的通信协议
    - 通过三次握手建立连接，通讯完成时要拆除连接
    - 由于TCP是面向连接的所以只能用于端到端的通讯
  - Socket之UDP
    - UDP是面向无连接的通讯协议
    - UDP数据包括目的端口号和源端口号信息
    - 由于通讯不需要连接，所以可以实现广播发送，并不局限于端到端
  - Client-Server Application
    - TCP/IP协议中，两个进程间通信的主要模式为：CS模型
    - 主要目的：协同网络中的计算机资源、服务模式、进程间数据共享
    - 常见的：FTP、SMTP、HTTP
- Socket TCP牛刀小试-客户端实现
  - 构建TCP客户端、服务端
  - 客户端发送数据
  - 服务器读取数据并打印
- 报文、协议、Mac地址
  - 报文段
    - 报文段是指TCP/IP协议网络传输过程中，起着路由导航作用
    - 用以查询各个网络路由网段、IP地址、交换协议等IP数据包
    - 报文段充当整个TCP/IP协议数据包的导航路由功能
    - 报文在传输过程中会不断地封装成分组、包、帧来传输
    - 封装方式就是添加一些控制信息组成的首部，即报文头
  - 传输协议
    - 协议顾名思义，一种规定，约束
    - 约定大于配置，在网络传输中依然适用；网络的传输流程是健壮的稳定的，得益于基础的协议构成
    - 简单来说：A->B的传输数据，B能识别，反之B->A的传输数据A也能识别，这就是协议
  - Mac地址
    - Media Access Control或者Medium Access Control
    - 意译为媒体访问控制，或称为物理地址、硬件地址
    - 用来定义网络设备的位置
    - 形如：44-45-53-54-00-00；与身份证类似
- IP、端口及远程服务器
  - IP地址
    - 互联网协议地址（英语：Internet Protocol Address，又译为网际协议地址），缩写为IP地址（英语：IP Address）
    - 是分配给网络上使用网际协议（英语：Internet Protocol，IP）的设备的数字标签
    - 常见的IP地址分为IPv4与IPv6两大类
    - IP地址由32位二进制数组成，常以XXX.XXX.XXX.XXX形式表现，每组XXX代表小于或等于255的10进制数
    - 如：208.80.152.2
    - 分为A、B、C、D、E五大类，其中E类属于特殊保留地址
  - IP地址-IPv4
    - 总数量：4,294,967,296个（即232）：42亿个；最终于2011年2月3日用尽
    - 如果主机号是全1，那么这个地址为直接广播地址
    - IP地址“255.255.255.255”为受限的广播地址
  - IP地址-IPv6
    - 总共有128位长，IPv6地址的表达形式，一般采用32个十六进制数。也可以想象为1632个
    - 由两个逻辑部分组成：一个64位的网络前缀和一个64位的主机地址，主机地址通常根据物理地址自动生成，叫做EUI-64（或者64位扩展唯一标识）
    - 2001:0db8:85a3:0000:1319:8a2e:0370:7344
    - IPv4转换为IPv6一定可行，IPv6转换为IPv4不一定可行
  - 端口
    - 如果把IP地址比作一间房子，端口就是出入之间房子的门或者窗户
    - 在不同门窗户后有不同的人，房子中的用户与外界交流的出口
    - 外界鸽子（信息）飞到不同窗户也就是不同的人传递信息
    - 0到1023号端口以及1024到49151号端口都是特殊端口
    - 计算机之间依照互联网传输层TCP/IP协议的协议通信，不同的协议都对应不同的端口
    - 49152到65535号端口属于“动态端口”范围，没有端口可以被正式地注册占用
  - 远程服务器
    - 局域网：一般而言，家里的环境以及公司相互电脑之间环境都属于局域网
    - 我与你们的电脑之间属于互联网，而非局域网
    - 默认的：我的电脑无法直接链接到你们的电脑
## 第3章 Socket UDP快速入门
- UDP是什么
  - UDP是什么
    - 英语：User Datagram Protocol，缩写为UDP
    - 一种用户数据报协议，又称用户数据报文协议
    - 是一个简单的面向数据报的传输层协议，正式规范为RFC 768
    - 用户数据协议、非连接协议
  - 为什么不可靠
    - 它一旦把应用程序发给网络层的数据发送出去，就不保留数据备份
    - UDP在IP数据报的头部仅仅加入了复用和数据校验（字段）
    - 发送端生产数据，接收端从网络中抓取数据
    - 结构简单、无校验、速度快、容易丢包、可广播
  - UDP能做什么
    - DNS、TFTP、SNMP
    - 视频、音频、普通数据（无关紧要数据）
  - UDP包最长长度
    - 16位 -> 2字节 存储长度信息
    - 2 ^ 16 - 1 = 64k - 1 = 65536 - 1 = 65535
    - 自身协议占用：32 + 32位 = 64位 = 8字节
    - 65535 - 8 = 65507 byte
- UDP单播、广播、多播
  - 广播地址
    - 255.255.255.255为受限广播地址
    - C网广播地址一般为：XXX.XXX.XXX.255（192.168.1.255）
    - D类IP地址为多播预留
  - 广播地址运算
    - IP：192.168.124.7
    - 子网掩码：255.255.255.0
    - 网络地址：192.168.124.0
    - 广播地址：192.168.124.255
## 第4章 Socket TCP快速入门
- TCP是什么、能做什么
  - TCP是什么
    - 英语：Transmission Control Protocol，缩写为TCP
    - TCP是传输控制协议；是一种面向连接的、可靠的、基于字节流的传输层通信协议，由IETF的RFC793定义
    - 与UDP一样完成第四层传输层所指定的功能与职责
  - TCP是什么
    - TCP机制
      - 三次握手、四次挥手
      - 具有校验机制、可靠、数据传输稳定
  - TCP能做什么
    - 聊天消息传输、推送
    - 单人语音、视频聊天等
    - 几乎UDP能做的都能做，但需要考虑复杂性、性能问题
    - 限制：无法进行广播、多播等操作
- TCP传输可靠性-排序、丢弃、重发
  - 排序、顺序发送、顺序组装
  - 丢弃、超时
  - 重发机制-定时器
## 第5章 UDP辅助TCP实现点对点传输案例
## 第6章 简易聊天室案例
- 聊天室数据传输设计
  - 必要条件：客户端、服务器
  - 必要约束：数据传输协议
  - 原理：服务器监听消息来源、客户端链接服务器并发送消息到服务器
- 服务器状态与测试用例构建
  - 服务器状态-繁忙
    - 每个客户端都需要服务器进行双通等待
    - 双通：客户端发送数据到服务器的接收通道
    - 双通：服务器回送消息的发送通道
    - 每条通道因为阻塞只能使用异步线程实现
  - 服务器线程数量
    - 一个客户端：双通->2条线程
    - n个客户端：2n条线程
    - 服务器实际线程数量：2n+
- 服务器性能总结与优化方案
  - 服务器性能数据分析
    - CPU：取决于数据的屏风性、数据的转发复杂性
    - 内存：取决于客户端的数量、客户端发送的数据大小
    - 线程：取决于连接的客户端的数量
  - 服务器优化方案分析
    - 减少线程数量
    - 增加线程执行繁忙状态
    - 客户端Buffer复用机制
## 第7章 服务器传输优化-NIO
- 阻塞IO和非阻塞IO
  - 非阻塞IO
    - NIO全称：Non-blocking I/O
    - JDK1.4引入全新的输入输出标准库NIO，也叫New I/O
    - 在标准Java代码中提供了高速的、可伸缩性的、面向块的、非阻塞的IO操作
- NIO Family一览
  - Buffer缓冲区：用于数据处理的基础单元，客户端发送与接收数据都需通过Buffer转发进行
  - Channel通道：类似于流，但不同于IN/OUT Stream，流具有独占性与单向性；通道则偏向于数据的流通多样性
  - Selectors选择器：处理客户端所有事件的分发器
  - Charset扩展部分
    - Charset字符编码：加密、解密
    - 原生支持的、数据通道级别的数据处理方式，可以用于数据传输级别的数据加密、解密等操作
- NIO知识归纳梳理
  - NIO vs IO
    - IO：以流为导向，阻塞IO
    - NIO：以缓冲区为导向，非阻塞IO，Selector选择器
## 第8章 数据传输稳定性优化
- 消息不完整与消息粘包
  - 消息粘包
    - TCP本质上并不会发生数据层面的粘包
    - TCP的发送方与接收方一定会确保数据是以一种有序的方式到达客户端
    - 并且会确保数据包完整
    - UDP不保证消息完整性，所以UDP外网发生丢包等情况
    - TCP数据传输具有：顺序性、完整性
    - 在常规所说Socket“粘包”，并非数据传输层面粘包
    - "粘包“是数据处理的逻辑层面上发生的粘包
    - 这里所说的“粘包”：包含TCP、UDP甚至其他任意的数据流交互方案
    - Mina、Netty等框架从根本来说也是为了解决粘包而设计的高并发库
  - 消息不完整
    - 从数据的传输层面来讲TCP也不会发生数据丢失不全等情况
    - 一旦出现一定是TCP停止运行终止之时
    - “数据不完整”依然针对的是数据的逻辑接收层面
    - 在物理传输层面来讲数据一定是能安全地完整地送达另一端
    - 但另一端可能缓冲区不够或者数据处理上不够完整导致数据只能读取一部分数据
    - 这种情况称为“数据不完整”“数据丢包”等
- 传输分析-如何有序地混传数据
  - 数据传输加上开始结束标记
  - 数据传输使用固定头部的方案
  - 混合方案：固定头部、数据加密、数据描述
## 第9章 局域网文件快传技术实战
- 混传数据总结与梳理
  - 构建有序消息体
    - 数据包分析与特征提取
    - 数据头部构建
    - 数据头、数据体接收
- 文件传输与普通传输区别
  - 最大的差别：文件数据bytes远远大于普通数据bytes
  - 文件传输需分片，组装分片
  - 文件传输如何中途取消而不影响后续的Packet发送
- 文件消息模型分片实现
  - 发送中无法取消文件发送
  - 大文件传输容错率较低
  - 同一链接无法实现文件、普通消息优先级
## 第10章 聊天室升级版实战
- 心跳包必要性与策略选择
  - 为什么需要心跳包
    - CS模型中如何相互知晓状态
    - 从TCP理论来说不需要心跳包-客户端服务器直连
    - 程序崩溃、防火墙
    - 网络运营商（ISP）-> NAT路由器（映射状态表）
  - 心跳包的作用
    - 客户端与服务器之间相互告知状态
    - 通过定时发送信息，让自己运营商的NAT路由表得以维持；避免路由表过期带来的异常中断
    - 由于其约定性、定时性所以称为心跳包
  - 心跳策略选择
    - TCP：KeepAlive 7200 2H ACK
    - TCP：KeepAlive仅代表连接保持，而不代表对方业务层是否可消费数据
  - 心跳包发送与消费
    - 客户端发送心跳数据，服务器接收数据，但并不回送业务数据包；此时客户端依然会收到数据确认包（ACK）
    - 服务器使用10倍长时扫描客户端方案进行客户端活跃性扫描，超出时间未活跃则自动关闭链接
## 第11章 语音数据即时通信实战
## 第12章 整体代码结构梳理与升华
## 第13章 课程总结
 
- 涉及到的数据结构
  - Packet
  - Frame
  - IoArgs
  - ByteBuffer

- 规则
  - Packet规则（代码中未体现）
    - 包头（4byte）
    - 包体（Stream）
  - 分片消息规则
    - 帧头
      - 当前帧大小 2-byte 16位
      - 帧类型 1-byte 8位
      - 帧标志信息 1-byte 8位
      - 对应包唯一标识 1-byte 8位
      - 预留空间 1-byte 8位
    - 帧体
      - 数据区 Frame Payload